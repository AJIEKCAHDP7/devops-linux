# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ iptables –≤ Linux

`iptables` ‚Äî —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π firewall Linux –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã–º —Ç—Ä–∞—Ñ–∏–∫–æ–º.

–ü–æ–∑–≤–æ–ª—è–µ—Ç:
‚úÖ –†–∞–∑—Ä–µ—à–∞—Ç—å –∏ –∑–∞–ø—Ä–µ—â–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è  
‚úÖ –ó–∞—â–∏—â–∞—Ç—å —Å–µ—Ä–≤–µ—Ä  
‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å NAT  
‚úÖ –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç—ã

---

## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è iptables

–ü—Ä–æ–≤–µ—Ä—å, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ iptables:
iptables --version

2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ iptables
Ubuntu / Debian
sudo apt update
sudo apt install iptables iptables-persistent

CentOS / RHEL / Rocky
sudo dnf install iptables-services

3. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤–∏–ª
iptables -L -v -n

-L ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–∏–ª

-v ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ

-n ‚Äî –±–µ–∑ DNS

4. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª (–û–°–¢–û–†–û–ñ–ù–û)

‚ö†Ô∏è –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞!

iptables -F
iptables -X
iptables -t nat -F

5. –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
–†–∞–∑—Ä–µ—à–∞–µ–º localhost
iptables -A INPUT -i lo -j ACCEPT

–†–∞–∑—Ä–µ—à–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

–†–∞–∑—Ä–µ—à–∞–µ–º SSH (–ø–æ—Ä—Ç 22)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT


(–ï—Å–ª–∏ SSH –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É ‚Äî –ø–æ–º–µ–Ω—è–π)

6. –†–∞–∑—Ä–µ—à–∞–µ–º HTTP / HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

7. –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT


üëâ –í—Å—ë, —á—Ç–æ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.

8. NAT (—Ä–∞–∑–¥–∞—á–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)

–î–ª—è —Ä–æ—É—Ç–µ—Ä–∞ / —Å–µ—Ä–≤–µ—Ä–∞-—à–ª—é–∑–∞.

–í–∫–ª—é—á–∞–µ–º forward
echo 1 > /proc/sys/net/ipv4/ip_forward


–ü–æ—Å—Ç–æ—è–Ω–Ω–æ:

nano /etc/sysctl.conf


–î–æ–±–∞–≤—å:

net.ipv4.ip_forward=1

–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º NAT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE


(eth0 ‚Äî –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

9. –ó–∞—â–∏—Ç–∞ –æ—Ç brute-force (SSH)
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW \
-m recent --set

iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW \
-m recent --update --seconds 60 --hitcount 5 -j DROP


üëâ –ë–ª–æ–∫ –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ –º–∏–Ω—É—Ç—É.

10. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP
–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP
iptables -A INPUT -s 1.2.3.4 -j DROP

–†–∞–∑—Ä–µ—à–∏—Ç—å IP
iptables -A INPUT -s 1.2.3.4 -j ACCEPT

11. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
iptables -A INPUT -j LOG --log-prefix "IPTABLES_DROP: "


–õ–æ–≥–∏:

journalctl -k

12. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
Ubuntu / Debian
sudo netfilter-persistent save


–∏–ª–∏

iptables-save > /etc/iptables/rules.v4

CentOS / RHEL
service iptables save


–∏–ª–∏

iptables-save > /etc/sysconfig/iptables

13. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
iptables-restore < /etc/iptables/rules.v4

14. –ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π firewall –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
iptables -F

iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

iptables -A INPUT -i lo -j ACCEPT

iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

–ò—Ç–æ–≥

iptables –ø–æ–∑–≤–æ–ª—è–µ—Ç:

‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫
‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
‚úÖ –î–µ–ª–∞—Ç—å NAT –∏ VPN
‚úÖ –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∞—Ç–∞–∫–∏

–î–ª—è –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑—É—á–∞—Ç—å —Ç–∞–∫–∂–µ nftables.


---

# –¢–∞–±–ª–∏—Ü—ã iptables –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í iptables –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü, –∫–∞–∂–¥–∞—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ–π —ç—Ç–∞–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–∫–µ—Ç–æ–≤.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
‚úÖ filter  
‚úÖ nat  
‚úÖ mangle  
‚úÖ raw  
‚úÖ security

---

## 1. –¢–∞–±–ª–∏—Ü–∞ `filter` (–æ—Å–Ω–æ–≤–Ω–∞—è)

üëâ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞.

–≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏:
- INPUT ‚Äî –≤—Ö–æ–¥—è—â–∏–µ –ø–∞–∫–µ—Ç—ã
- OUTPUT ‚Äî –∏—Å—Ö–æ–¥—è—â–∏–µ
- FORWARD ‚Äî —Ç—Ä–∞–Ω–∑–∏—Ç

### –ü—Ä–∏–º–µ—Ä:
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
–†–∞–∑—Ä–µ—à–∞–µ—Ç SSH.

2. –¢–∞–±–ª–∏—Ü–∞ nat (NAT, –ø–æ–¥–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–æ–≤)
üëâ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è IP-–∞–¥—Ä–µ—Å–æ–≤ –∏ –ø–æ—Ä—Ç–æ–≤.

–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏:
PREROUTING ‚Äî –¥–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
POSTROUTING ‚Äî –ø–æ—Å–ª–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
OUTPUT ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫

–ü—Ä–∏–º–µ—Ä (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—à–ª—é–∑):
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

3. –¢–∞–±–ª–∏—Ü–∞ mangle (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤)
üëâ –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤:
TTL
QoS
MARK
TOS

–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏:
PREROUTING
INPUT
FORWARD
OUTPUT
POSTROUTING

–ü—Ä–∏–º–µ—Ä (–∏–∑–º–µ–Ω–∏—Ç—å TTL):
iptables -t mangle -A POSTROUTING -j TTL --ttl-set 64

4. –¢–∞–±–ª–∏—Ü–∞ raw (–¥–æ conntrack)
üëâ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (conntrack).

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–∏—è tracking
‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚úÖ Anti-DDoS

–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏:
PREROUTING
OUTPUT

–ü—Ä–∏–º–µ—Ä (–æ—Ç–∫–ª—é—á–∏—Ç—å tracking):
iptables -t raw -A PREROUTING -p udp --dport 53 -j NOTRACK

5. –¢–∞–±–ª–∏—Ü–∞ security (SELinux)
üëâ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å SELinux.

–†–µ–¥–∫–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏:
INPUT
OUTPUT
FORWARD

–ü—Ä–∏–º–µ—Ä:
iptables -t security -A INPUT -p tcp --dport 80 -j ACCEPT
(–ê–∫—Ç—É–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω SELinux)

6. –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
–í—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç (INPUT):
raw ‚Üí mangle ‚Üí nat ‚Üí filter ‚Üí app

–ò—Å—Ö–æ–¥—è—â–∏–π –ø–∞–∫–µ—Ç (OUTPUT):
raw ‚Üí mangle ‚Üí nat ‚Üí filter ‚Üí net

–¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–π (FORWARD):
raw ‚Üí mangle ‚Üí nat ‚Üí filter ‚Üí net

7. –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
iptables -L
iptables -t nat -L
iptables -t mangle -L
iptables -t raw -L
iptables -t security -L

8. –ö—Ä–∞—Ç–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞
–¢–∞–±–ª–∏—Ü–∞	–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ	–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
filter	–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è	Firewall
nat	–ü–æ–¥–º–µ–Ω–∞ –∞–¥—Ä–µ—Å–æ–≤	NAT, Port Forwarding
mangle	–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤	QoS, MARK, TTL
raw	–î–æ conntrack	–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, Anti-DDoS
security	SELinux	–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞

9. –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–û–±—ã—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
‚û°Ô∏è filter + nat

–†–æ—É—Ç–µ—Ä / —à–ª—é–∑
‚û°Ô∏è filter + nat + mangle

–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
‚û°Ô∏è raw + mangle

SELinux
‚û°Ô∏è security

–ò—Ç–æ–≥
iptables —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 5 —Ç–∞–±–ª–∏—Ü:

üî• filter ‚Äî –≥–ª–∞–≤–Ω—ã–π firewall
üî• nat ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
üî• mangle ‚Äî —Ç—é–Ω–∏–Ω–≥ –ø–∞–∫–µ—Ç–æ–≤
üî• raw ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å conntrack
üî• security ‚Äî SELinux









